name: Invite user from Issue Body Key
on:
  issues:
    types: [opened] 

jobs:
  invite:
    runs-on: ubuntu-latest
    permissions:
      issues: write # Grants the GITHUB_TOKEN permission to post comments
      contents: read
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Extract Key from Issue Body and Compare
        id: extract
        env:
          # IMPORTANT: This secret MUST be set to your actual secret string (e.g., GUESTPASS2025)
          EXPECTED_KEY: ${{ secrets.INVITE_LABEL_KEY }}
        run: |
          # Robust extraction: find the line, then use awk to get the value after the colon.
          INVITE_KEY=$(echo "${{ github.event.issue.body }}" | grep -i 'INVITE_KEY:' | awk -F':' '{print $2}' | xargs)
          EXPECTED_KEY_CLEAN=$(echo "$EXPECTED_KEY" | xargs)
          
          echo "Expected Key: $EXPECTED_KEY_CLEAN"
          echo "User Key: $INVITE_KEY"
          
          # Set output for the next step to use
          if [ "$INVITE_KEY" == "$EXPECTED_KEY_CLEAN" ]; then
            echo "key_matched=true" >> $GITHUB_OUTPUT
          else
            echo "key_matched=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Invite User (using PAT)
        uses: actions/github-script@v6
        id: invite
        # Use the powerful INVITE_TOKEN (PAT) for the sensitive Organization API call
        with:
          github-token: ${{ secrets.INVITE_TOKEN }} 
          script: |
            const keyMatched = '${{ steps.extract.outputs.key_matched }}';
            const user = context.payload.issue.user.login;
            const org = 'DITN1B-PUO-2025-2026';
            
            let message = '';
            
            // --- SCENARIO 1: KEY MATCH FAILURE ---
            if (keyMatched === 'false') {
                message = "The secret key provided in the issue body is incorrect. Please ensure you have the correct key and the format is **INVITE_KEY: YOUR_KEY**. The issue remains open.";
            } 
            // --- SCENARIO 2: KEY MATCH SUCCESS ---
            else {
                // Check if the user is already an owner/admin (This bypasses the 403 demotion error)
                const { data: userOrg } = await github.rest.orgs.getMembershipForUser({
                  org: org,
                  username: user,
                }).catch(() => ({ data: { role: null } })); // Catch if user is not a member (404)

                if (userOrg.role === 'admin' || userOrg.state === 'active') {
                    // This handles the 403 "You cannot demote yourself" scenario if the user is an owner/admin
                    message = `Hello @${user}, you are **already an active member** of the ${org} organization :D.`;
                } else {
                    try {
                      // Attempt to invite the user (role: 'member')
                      await github.rest.orgs.setMembershipForUser({
                        org: org,
                        username: user,
                        role: 'member'
                      });
                      
                      message = `**Welcome to ${org}, @${user}!** ðŸŽ‰ You have been invited successfully.`;

                    } catch (error) {
                       // Log other errors
                       console.error('Invite failed:', error);
                       message = `**ERROR:** The invite failed with status **${error.status}**. Please ensure the INVITE_TOKEN has the 'admin:org' scope.`;
                    }
                }
            }
            
            // Pass the resulting message to the next step for commenting
            core.setOutput('comment_body', message);

      - name: Post Comment (using GITHUB_TOKEN)
        uses: actions/github-script@v6
        # Use the default GITHUB_TOKEN, which has 'issues: write' permission.
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} 
          script: |
            const commentBody = '${{ steps.invite.outputs.comment_body }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });