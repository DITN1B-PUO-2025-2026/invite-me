name: Invite user from Issue Body Key
on:
  issues:
    types: [opened] 

jobs:
  invite:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Extract Key from Issue Body
        id: extract
        # Pass the secret as an environment variable within this step
        env:
          EXPECTED_KEY: ${{ secrets.INVITE_LABEL_KEY }}
        run: |
          # The user's key extracted from the issue body
          INVITE_KEY=$(echo "${{ github.event.issue.body }}" | grep 'INVITE_KEY:' | awk '{print $2}')
          
          # Pass the extracted key as a step output
          echo "key=$INVITE_KEY" >> $GITHUB_OUTPUT
          
          # Also pass the EXPECTED_KEY as a step output so it can be used in the 'if' condition below
          echo "expected_key=$EXPECTED_KEY" >> $GITHUB_OUTPUT

      - name: Run Invite Action if Key Matches
        uses: vj-abigo/invite-on-label@v1.4
        # FIX: Compare the extracted key (output) with the expected key (also output from the first step)
        if: steps.extract.outputs.key == steps.extract.outputs.expected_key
        with:
          organization: DITN1B-PUO-2025-2026
          label: 'key-detected' # Dummy label
          comment: 'Welcome to the Org. You have been invited successfully! ðŸŽ‰'
          existingMemberMessage: 'You are already a member of the organization :D '
        env:
          INVITE_TOKEN: ${{ secrets.INVITE_TOKEN }}