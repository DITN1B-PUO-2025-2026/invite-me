name: Rotate Invitation Label Key

on:
  schedule:
    # Runs at 00:00 UTC daily. Adjust the cron schedule as needed.
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allows manual running

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Setup timezone
        uses: zcong1993/setup-timezone@master
        with:
          timezone: Asia/Kuala_Lumpur

      - name: Generate Random Label Key
        id: generate_key
        run: |
          # Generates a 32-character hexadecimal string
          NEW_KEY=$(openssl rand -hex 32)
          echo "::add-mask::$NEW_KEY"
          echo "NEW_KEY=$NEW_KEY" >> $GITHUB_OUTPUT

      - name: Update Repository Secret
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_SECRETS_UPDATE }}
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          SECRET_NAME: INVITE_LABEL_KEY
        run: |
          # Use the GitHub CLI to update the secret
          gh secret set $SECRET_NAME --body "$NEW_KEY" -R $GITHUB_REPOSITORY
          echo "ðŸ”„ Secret ${{ env.SECRET_NAME }} has been updated."

      - name: Send New Key to Discord via Webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }} # Pass URL to env
          BOT_AUTHORIZATION_HEADER: ${{ secrets.BOT_AUTHORIZATION_HEADER }} # Pass Authorization Header to env
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
        run: |
          CURRENT_DATE="$(date +%Y-%m-%d\ %H:%M\ UTC)"
          
          # 1. Define the JSON payload using secure double quotes and escaped internal quotes
          DISCORD_PAYLOAD="
          {
            \"content\": \"@everyone **ðŸ”‘ GitHub Invite Key Rotated!**\",
            \"embeds\": [
              {
                \"title\": \"New Organization Invitation Label Key\",
                \"description\": \"The key has been updated. Use this new key in an issue >\",
                \"color\": 3447003,
                \"fields\": [
                  {
                    \"name\": \"ðŸ”‘ Current Key\",
                    \"value\": \"$NEW_KEY\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  # The date command runs and inserts the UTC time string directly
                  \"text\": \"Key updated at $(date +%Y-%m-%d\ %H:%M\ UTC)\"
                }
              }
            ]
          }"

          # Use the environment variables ($VARIABLE_NAME) in the curl command
          echo "Sending Discord notification with @everyone ping..."

          CURL_COMMAND="curl -s -X POST \
               -H \"Authorization: $BOT_AUTHORIZATION_HEADER\" \
               -H \"Content-Type: application/json\" \
               -d '$DISCORD_PAYLOAD' \
               -o /dev/null \
               \"$DISCORD_WEBHOOK_URL\""

          bash -c "$CURL_COMMAND"

          echo "âœ… Discord notification sent."