name: Rotate Invitation Label Key

on:
  schedule:
    # Runs at 00:00 UTC daily. Adjust the cron schedule as needed.
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allows manual running

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Setup timezone
        uses: zcong1993/setup-timezone@master
        with:
          timezone: Asia/Kuala_Lumpur

      - name: Generate Random Label Key
        id: generate_key
        run: |
          # Generates a 32-character hexadecimal string
          NEW_KEY=$(openssl rand -hex 32)
          echo "::add-mask::$NEW_KEY"
          echo "NEW_KEY=$NEW_KEY" >> $GITHUB_OUTPUT

      - name: Update Repository Secret
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_SECRETS_UPDATE }}
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          SECRET_NAME: INVITE_LABEL_KEY
        run: |
          # Use the GitHub CLI to update the secret
          gh secret set $SECRET_NAME --body "$NEW_KEY" -R $GITHUB_REPOSITORY
          echo "ðŸ”„ Secret ${{ env.SECRET_NAME }} has been updated."

      - name: Send New Key to Discord via API (Non-Shell)
        id: send_discord
        uses: actions/github-script@v6
        env:
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          BOT_AUTH_HEADER: ${{ secrets.BOT_AUTHORIZATION_HEADER }}
          DISCORD_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          # Use Node.js to securely build and send the request
          script: |
            const key = process.env.NEW_KEY;
            const authHeader = process.env.BOT_AUTH_HEADER;
            const discordUrl = process.env.DISCORD_URL;
            const dateString = new Date().toISOString().slice(0, 16).replace('T', ' ');
            
            // 1. Construct the JSON payload (JavaScript object)
            const payload = {
              content: "@everyone **ðŸ”‘ GitHub Invite Key Rotated!**",
              embeds: [{
                title: "New Organization Invitation Label Key",
                description: "The key has been updated. Use this new key in an issue >",
                color: 3447003,
                fields: [{
                  name: "ðŸ”‘ Current Key",
                  value: key,
                  inline: false
                }],
                footer: {
                  // Note: This uses Node's standard time, adjust as needed.
                  text: `Key updated at ${dateString} UTC`
                }
              }]
            };

            // 2. Use fetch (Node's standard HTTP client) to send the request
            const response = await fetch(discordUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                // Authorization header is passed here
                'Authorization': authHeader
              },
              body: JSON.stringify(payload)
            });

            // 3. Fail the step if the API call fails (e.g., HTTP 400, 403)
            if (!response.ok) {
              const responseBody = await response.text();
              throw new Error(`Discord API failed with status ${response.status}: ${responseBody}`);
            }