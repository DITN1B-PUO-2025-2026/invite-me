name: Rotate Invitation Label Key

on:
  schedule:
    # Runs at 00:00 UTC daily. Adjust the cron schedule as needed.
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allows manual running

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Setup timezone
        uses: zcong1993/setup-timezone@master
        with:
          timezone: Asia/Kuala_Lumpur

      - name: Generate Random Label Key
        id: generate_key
        run: |
          # Generates a 32-character hexadecimal string
          NEW_KEY=$(openssl rand -hex 4)
          echo "::add-mask::$NEW_KEY"
          echo "NEW_KEY=$NEW_KEY" >> $GITHUB_OUTPUT

      - name: Update Repository Secret
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_SECRETS_UPDATE }}
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          SECRET_NAME: INVITE_LABEL_KEY
        run: |
          # Use the GitHub CLI to update the secret
          gh secret set $SECRET_NAME --body "$NEW_KEY" -R $GITHUB_REPOSITORY
          echo "ðŸ”„ Secret ${{ env.SECRET_NAME }} has been updated."

      - name: Send New Key to Discord via API (Non-Shell)
        id: send_discord
        uses: actions/github-script@v6
        env:
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          BOT_AUTH_HEADER: ${{ secrets.BOT_AUTHORIZATION_HEADER }}
          DISCORD_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          script: |
            const key = process.env.NEW_KEY;
            const keyString = key ?? '';
            if (!keyString) {
              console.warn('NEW_KEY is empty or undefined');
            }
            const authHeader = process.env.BOT_AUTH_HEADER;
            const discordUrl = process.env.DISCORD_URL;
            
            // ðŸš¨ Timezone FIX: Use sv-SE locale for YYYY-MM-DD HH:MM format in Kuala Lumpur timezone (MYT) ðŸš¨
            const mytTime = new Date().toLocaleString('en-GB', {
              timeZone: 'Asia/Kuala_Lumpur',
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true // This ensures AM/PM is used
            });
            
            // 1. Construct the JSON payload (JavaScript object)
            const payload = {
              content: "@everyone **ðŸ”‘ GitHub Invite Key Rotated!**",
              embeds: [{
                title: "New Organization Invitation Label Key",
                description: "The key has been updated. Use this new key in an issue > [Github Issues](https://github.com/DITN1B-PUO-2025-2026/invite-me/issues/new)",
                color: 3447003,
                fields: [{
                  name: "ðŸ”‘ Current Key",
                  value: `INVITE_KEY: ${keyString}`,
                  inline: false
                }],
                footer: {
                  // Use the localized time string and manually append the MYT suffix
                  text: `Key updated at ${mytTime} MYT`
                }
              }]
            };
            
            // 2. Use fetch (Node's standard HTTP client) to send the request
            const response = await fetch(discordUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': authHeader
              },
              body: JSON.stringify(payload)
            });

            // 3. Fail the step if the API call fails (e.g., HTTP 400, 403)
            if (!response.ok) {
              const responseBody = await response.text();
              throw new Error(`Discord API failed with status ${response.status}: ${responseBody}`);
            }