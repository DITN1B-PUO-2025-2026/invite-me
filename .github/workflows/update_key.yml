name: Rotate Invitation Label Key

on:
  schedule:
    # Runs at 00:00 UTC daily. Adjust the cron schedule as needed.
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allows manual running

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Random Label Key
        id: generate_key
        run: |
          # Generates a 32-character hexadecimal string
          NEW_KEY=$(openssl rand -hex 32)
          echo "NEW_KEY=$NEW_KEY" >> $GITHUB_OUTPUT

      - name: Update Repository Secret
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_SECRETS_UPDATE }}
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
          SECRET_NAME: INVITE_LABEL_KEY
        run: |
          # Use the GitHub CLI to update the secret
          gh secret set $SECRET_NAME --body "$NEW_KEY" -R $GITHUB_REPOSITORY
          echo "ðŸ”„ Secret ${{ env.SECRET_NAME }} has been updated."

      - name: Send New Key to Discord via Webhook
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NEW_KEY: ${{ steps.generate_key.outputs.NEW_KEY }}
        run: |
          # Define the JSON payload for the Discord webhook
          DISCORD_PAYLOAD='{
            "content": "@everyone **ðŸ”‘ GitHub Invite Key Rotated!**",
            "embeds": [
              {
                "title": "New Organization Invitation Label Key",
                "description": "The key has been updated. Use this new key in an issue >",
                "color": 3447003,
                "fields": [
                  {
                    "name": "ðŸ”‘ Current Key",
                    "value": "'"'"$NEW_KEY"'"'",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Key updated at '"'"$(date +%Y-%m-%d\ %H:%M\ UTC)"'"'"
                }
              }
            ]
          }'

          curl -X POST \
               -H "Authorization: ${{ secrets.BOT_AUTHORIZATION_HEADER }}" \
               -H "Content-Type: application/json" \
               -d "$DISCORD_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
               
